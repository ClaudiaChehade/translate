<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title> 20240628_nrcs_bev_tools.tar.gz Tool Collection -Wave 3 Development </title>

    
    <link rel="stylesheet" href="assets/css/expand-macro.css">

            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

    </head>

<body pageid="2458153956">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">wave3</span>
                    <img class="space-logo" src="global.logo" />
                </h1>
                <a href="2458153956_PER.html" class="ht-space-link">
                    <h2>wave 3 development</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=4416914771"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="2458153956_PER.html">wave 3 development</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="1741913013_Map_and_Loc.html">Map and Loc</a></li>
                                                                                                         <li class="shortcut"><a href="2453670978_03_Calibration.html">03_Calibration</a></li>
                                                                                                         <li class="shortcut"><a href="2515113871_09_Release.html">09 Release</a></li>
                                                                                     <li><a href="2754796745_xcalib_prod.html">xcalib_prod</a></li>
                                                            </ul>
</div>            <h1 id="src-4416914771"> <span> 20240628_nrcs_bev_tools.tar.gz tool collection </span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">

    <div class="section section-1" id="src-4416914771_safe-id-aWQt546v6KeG55u45py6QkVW5ou85o6l5pWw5o2u5YiG5p6Q5oyH5Y2X5YW85a65c2hhZG93X21vZGXjgIFwYXJraW5n44CB5Lqn57q_5qCH5a6a5ZKM5ZSu5ZCO5qCH5a6a5pWw5o2u5aSE55CGLeWKn-iDveamgui_sA">
        <h1 class="heading "><span> Functional Overview </span></h1>
<ul class=" "><li class=" "><p   
> Shadow_mode data pre -processing (whether the check packet is valid, search DUMP data according to VIN, statistics of the time stamp information of multiple data packets in the same car, and calibration parameter query results) </p>
</li><li class=" "><p   
> Extract the original image and calibration parameter from Rosbag </p>
</li><li class=" "><p   
> Based on the timestamp of the front -view camera, synchronize the 4 -way surround camera image to generate effective frames (record the original timestamp and difference, and check whether the splicing effect is not good due to different splicing effects) </p>
</li><li class=" "><p   
> Generate BEV stitching related files according to the calibration parameter </p>
</li><li class=" "><p   
> Batch bev stitching </p>
</li></ul>    </div>
    <div class="section section-1" id="src-4416914771_safe-id-aWQt546v6KeG55u45py6QkVW5ou85o6l5pWw5o2u5YiG5p6Q5oyH5Y2X5YW85a65c2hhZG93X21vZGXjgIFwYXJraW5n44CB5Lqn57q_5qCH5a6a5ZKM5ZSu5ZCO5qCH5a6a5pWw5o2u5aSE55CGLeatpemqpOS4gO-8muaVsOaNrumihOWkhOeQhu-8iOS7hemSiOWvuXNoYWRvd21vZGXmlbDmja7vvIk">
        <h1 class="heading "><span> Step 1: Data pre -processing (only for Shadow Mode data) </span></h1>
<ul class=" "><li class=" "><p   
> Extract the VIN code and timestamp information of the vehicle in the packet, check the completeness of the required ROSTOPIC, screen the valid data <br/></p>
<ul class=" "><li class=" "><p   
> /A/ARA_COM_Gateway (_SLAVE)/Sensor_CALIB_PARAMETER_SENDERPORT → calibrate parameters </p>
</li><li class=" "><p   
> /C/Camera/Nearrangefront → The original image of the camera </p>
</li><li class=" "><p   
> /C/Camera/Nearrangerear → Later View of the camera original image </p>
</li><li class=" "><p   
> /C/Camera/Nearrangeleft → Left Ripid Camera Primitive Image </p>
</li><li class=" "><p   
> /C/Camera/Nearrangeright → Right -view camera original image </p>
</li></ul></li></ul><ul class=" "><li class=" "><p   
> At present, all data packets lack calibration parameters. The temporary solution is to find from DUMP data (creating a raw_data subfolder under the DUMP folder, and the original data of the cloud after decompression is stored. </p>
</li><li class=" "><p   
> Shadow Mode data address </p>
<ul class=" "><li class=" "><p   
>\\<a  class="external-link" href="http://bosch.com">bosch.com</a> \ DFSRB \ DFSCN \ DIV \ XC \ Engineering \ Domain \ Wave3 \ \ 00_DataExchange \ Shadowmode \ 20240624 → Parking's visual camera image recorded </p>
</li><li class=" "><p   
>\\<a  class="external-link" href="http://bosch.com">bosch.com</a> \ DFSRB \ DFSCN \ DIV \ XC \ Engineering \ Domain \ Wave3 \ 00_DataExchange2 \ shadowmode \ jpg.zip → production line or after -sales DUMP data (including original sensor data and standard files) </p>
</li><li class=" "><p   
>\\<a  class="external-link" href="http://bosch.com">bosch.com</a> \ DFSRB \ DFSCN \ DIV \ XC \ Engineering \ Domain \ Wave3 \ \ 00_DataExchange \ Shadowmode \ CALI_DUMP → Production line or after -sales DUMP data (only defined files) </p>
</li></ul></li></ul><p   
>    <span style="color: #ff0000;"> Python is waiting to be perfected: The same car may go through multiple production lines and after -sales calibration. At present, it is a new calibration parameter. The correct approach should be the calibration parameter that comes with the data packet (no recording at present) </span>
</p>
<p   
>    <span style="color: #ff0000;">
    <span style="color: #ff0000;">
python3 handel_shadow_mode_data.py -p data_path    </span>
    </span>
    <span style="color: #ff0000;">
    <span style="color: #ff0000;">
 -d dump_path    </span>
    </span>
    <span style="color: #ff0000;">
    <span style="color: #ff0000;">
 -o output_path    </span>
    </span>
</p>
<ul class=" "><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #ff0000;">
    <span style="color: #000000;"> -P / data_path: shadow_mode data path </span>
    </span>
    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #ff0000;">
    <span style="color: #000000;"> -d / output_path: parsing data output path </span>
    </span>
    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #ff0000;">
    <span style="color: #000000;">
    <span style="color: #ff0000;">
    <span style="color: #000000;"> -O / dump_path: Dump data path </span>
    </span>
    </span>
    </span>
    </span>
</p>
</li></ul>    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">handel_shadow_mode_data.py</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="handel_shadow_mode_data.py" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="keyword">import</code><code class="plain"> re</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> os</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> gzip</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> shutil</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> argparse</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> subprocess</code></div>
<div class="line"><code class="keyword">from</code><code class="plain"> datetime </code><code class="keyword">import</code><code class="plain"> datetime</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">def</code><code class="plain"> check_rostopic(data_path): </code><code class="comments"># -- TODO: return false</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">for</code><code class="plain"> root, _, files </code><code class="keyword">in</code><code class="plain"> os.walk(data_path):</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">for</code><code class="plain"> </code><code class="functions">file</code><code class="plain"> </code><code class="keyword">in</code><code class="plain"> files:</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">if</code><code class="plain"> </code><code class="functions">file</code><code class="plain">.endswith(</code><code class="string">".bag"</code><code class="plain">):</code></div>
<div class="line"><code class="plain">                bag_path </code><code class="keyword">=</code><code class="plain"> os.path.join(root, </code><code class="functions">file</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">print</code><code class="plain">(f</code><code class="string">"\n{file}"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">try</code><code class="plain">:</code></div>
<div class="line"><code class="plain">                    info_output </code><code class="keyword">=</code><code class="plain"> subprocess.check_output([</code><code class="string">'rosbag'</code><code class="plain">, </code><code class="string">'info'</code><code class="plain">, bag_path], stderr</code><code class="keyword">=</code><code class="plain">subprocess.STDOUT, text</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                    nrcs_info </code><code class="keyword">=</code><code class="plain"> []</code></div>
<div class="line"><code class="plain">                    calib_info </code><code class="keyword">=</code><code class="plain"> []</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">for</code><code class="plain"> line </code><code class="keyword">in</code><code class="plain"> info_output.split(</code><code class="string">'\n'</code><code class="plain">):</code></div>
<div class="line"><code class="plain">                        </code><code class="keyword">if</code><code class="plain"> </code><code class="string">'/C/Camera/NearRange'</code><code class="plain"> </code><code class="keyword">in</code><code class="plain"> line:</code></div>
<div class="line"><code class="plain">                            nrcs_info.append(line)</code></div>
<div class="line"><code class="plain">                        </code><code class="keyword">if</code><code class="plain"> </code><code class="string">'sensor_calib_parameter_senderport'</code><code class="plain"> </code><code class="keyword">in</code><code class="plain"> line:</code></div>
<div class="line"><code class="plain">                            calib_info.append(line)</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">if</code><code class="plain"> nrcs_info:</code></div>
<div class="line"><code class="plain">                        </code><code class="keyword">for</code><code class="plain"> info </code><code class="keyword">in</code><code class="plain"> nrcs_info:</code></div>
<div class="line"><code class="plain">                            </code><code class="keyword">print</code><code class="plain">(info)</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">if</code><code class="plain"> calib_info:</code></div>
<div class="line"><code class="plain">                        </code><code class="keyword">for</code><code class="plain"> info </code><code class="keyword">in</code><code class="plain"> calib_info:</code></div>
<div class="line"><code class="plain">                            </code><code class="keyword">print</code><code class="plain">(info)</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">except</code><code class="plain"> subprocess.CalledProcessError as e:</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">print</code><code class="plain">(f</code><code class="string">"fail to run rosbag info: {bag_path} -> {e.output}"</code><code class="plain">)       </code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">def</code><code class="plain"> convert_filename(filename):</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">if</code><code class="plain"> filename.endswith(</code><code class="string">'_yaml'</code><code class="plain">):</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> filename.replace(</code><code class="string">'_yaml'</code><code class="plain">, </code><code class="string">'.yaml'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">elif</code><code class="plain"> filename.endswith(</code><code class="string">'_jpg'</code><code class="plain">):</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> filename.replace(</code><code class="string">'_jpg'</code><code class="plain">, </code><code class="string">'.jpg'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">elif</code><code class="plain"> filename.endswith(</code><code class="string">'_txt'</code><code class="plain">):</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> filename.replace(</code><code class="string">'_txt'</code><code class="plain">, </code><code class="string">'.txt'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">else</code><code class="plain">:</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> filename</code></div>
<div class="line"><code class="plain">    </code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">def</code><code class="plain"> find_offline_calib(data_path, dump_path, output_path):</code></div>
<div class="line"><code class="plain">    os.makedirs(output_path, exist_ok</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    vin_timestamp_map </code><code class="keyword">=</code><code class="plain"> {}</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">for</code><code class="plain"> filename </code><code class="keyword">in</code><code class="plain"> os.listdir(data_path):</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> filename.endswith(</code><code class="string">'.bag'</code><code class="plain">):</code></div>
<div class="line"><code class="plain">            parts </code><code class="keyword">=</code><code class="plain"> os.path.splitext(filename)[</code><code class="value">0</code><code class="plain">].split(</code><code class="string">'_'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">if</code><code class="plain"> </code><code class="functions">len</code><code class="plain">(parts) ></code><code class="keyword">=</code><code class="plain"> </code><code class="value">5</code><code class="plain">:</code></div>
<div class="line"><code class="plain">                vin </code><code class="keyword">=</code><code class="plain"> parts[</code><code class="value">3</code><code class="plain">]</code></div>
<div class="line"><code class="plain">                timestamp </code><code class="keyword">=</code><code class="plain"> parts[</code><code class="value">4</code><code class="plain">]</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">if</code><code class="plain"> vin </code><code class="keyword">not</code><code class="plain"> </code><code class="keyword">in</code><code class="plain"> vin_timestamp_map:</code></div>
<div class="line"><code class="plain">                    vin_timestamp_map[vin] </code><code class="keyword">=</code><code class="plain"> []</code></div>
<div class="line"><code class="plain">                vin_timestamp_map[vin].append(timestamp)</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    keywords </code><code class="keyword">=</code><code class="plain"> [</code><code class="string">'nrcs_front_yaml'</code><code class="plain">, </code><code class="string">'nrcs_rear_yaml'</code><code class="plain">, </code><code class="string">'nrcs_left_yaml'</code><code class="plain">, </code><code class="string">'nrcs_right_yaml'</code><code class="plain">,</code></div>
<div class="line"><code class="plain">                </code><code class="string">'nrcs_front_jpg'</code><code class="plain">, </code><code class="string">'nrcs_rear_jpg'</code><code class="plain">, </code><code class="string">'nrcs_left_jpg'</code><code class="plain">, </code><code class="string">'nrcs_right_jpg'</code><code class="plain">,</code></div>
<div class="line"><code class="plain">                </code><code class="comments">#'cam_0_txt', 'cam_1_txt', 'cam_2_txt', 'cam_3_txt', 'extrinsics_txt'</code></div>
<div class="line"><code class="plain">               ]</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="keyword">for</code><code class="plain"> vin, timestamps </code><code class="keyword">in</code><code class="plain"> vin_timestamp_map.items():</code></div>
<div class="line"><code class="plain">        timestamps_datetime </code><code class="keyword">=</code><code class="plain"> [datetime.fromtimestamp(</code><code class="functions">int</code><code class="plain">(ts) </code><code class="keyword">/</code><code class="plain"> </code><code class="value">1000</code><code class="plain">).strftime(</code><code class="string">'%Y-%m-%d %H:%M:%S'</code><code class="plain">) </code><code class="keyword">for</code><code class="plain"> ts </code><code class="keyword">in</code><code class="plain"> timestamps]</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">print</code><code class="plain">(f</code><code class="string">'{vin} {sorted(timestamps_datetime)}'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        vin_directory </code><code class="keyword">=</code><code class="plain"> os.path.join(dump_path, vin)</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> </code><code class="keyword">not</code><code class="plain"> os.path.exists(vin_directory):</code></div>
<div class="line"><code class="plain">            os.makedirs(vin_directory)</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">for</code><code class="plain"> root, _, files </code><code class="keyword">in</code><code class="plain"> os.walk(os.path.join(dump_path, </code><code class="string">'raw_data'</code><code class="plain">)):</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">for</code><code class="plain"> </code><code class="functions">file</code><code class="plain"> </code><code class="keyword">in</code><code class="plain"> files:</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">if</code><code class="plain"> vin </code><code class="keyword">in</code><code class="plain"> </code><code class="functions">file</code><code class="plain"> </code><code class="keyword">and</code><code class="plain"> </code><code class="functions">file</code><code class="plain">.endswith(</code><code class="string">'.gz'</code><code class="plain">):</code></div>
<div class="line"><code class="plain">                    gz_file_path </code><code class="keyword">=</code><code class="plain"> os.path.join(root, </code><code class="functions">file</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                    with gzip.</code><code class="functions">open</code><code class="plain">(gz_file_path, </code><code class="string">'rb'</code><code class="plain">) as f_in:</code></div>
<div class="line"><code class="plain">                        with </code><code class="functions">open</code><code class="plain">(os.path.join(vin_directory, </code><code class="functions">file</code><code class="plain">[:</code><code class="keyword">-</code><code class="value">3</code><code class="plain">]), </code><code class="string">'wb'</code><code class="plain">) as f_out:</code></div>
<div class="line"><code class="plain">                            shutil.copyfileobj(f_in, f_out)</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">elif</code><code class="plain"> vin </code><code class="keyword">in</code><code class="plain"> </code><code class="functions">file</code><code class="plain">:</code></div>
<div class="line"><code class="plain">                    shutil.copy(os.path.join(root, </code><code class="functions">file</code><code class="plain">), vin_directory)</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments"># -- remove empty vin_directory</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> os.path.exists(vin_directory) </code><code class="keyword">and</code><code class="plain"> </code><code class="keyword">not</code><code class="plain"> os.listdir(vin_directory):</code></div>
<div class="line"><code class="plain">            os.rmdir(vin_directory)</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments"># -- copy image and yaml generate by offline calib</code></div>
<div class="line"><code class="plain">        bev_path </code><code class="keyword">=</code><code class="plain"> os.path.join(output_path, vin, </code><code class="string">'bev'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> [f </code><code class="keyword">for</code><code class="plain"> f </code><code class="keyword">in</code><code class="plain"> os.listdir(dump_path) </code><code class="keyword">if</code><code class="plain"> vin </code><code class="keyword">in</code><code class="plain"> f]: </code></div>
<div class="line"><code class="plain">            </code><code class="keyword">print</code><code class="plain">(f</code><code class="string">'--> find {vin} in dump_path'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            os.makedirs(bev_path, exist_ok</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            latest_files </code><code class="keyword">=</code><code class="plain"> {keyword: {</code><code class="string">'path'</code><code class="plain">: </code><code class="color1">None</code><code class="plain">, </code><code class="string">'timestamp'</code><code class="plain">: </code><code class="value">0</code><code class="plain">} </code><code class="keyword">for</code><code class="plain"> keyword </code><code class="keyword">in</code><code class="plain"> keywords}</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">for</code><code class="plain"> root, _, files </code><code class="keyword">in</code><code class="plain"> os.walk(os.path.join(dump_path, vin)):</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">for</code><code class="plain"> </code><code class="functions">file</code><code class="plain"> </code><code class="keyword">in</code><code class="plain"> files:</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">for</code><code class="plain"> keyword </code><code class="keyword">in</code><code class="plain"> keywords:</code></div>
<div class="line"><code class="plain">                        </code><code class="keyword">if</code><code class="plain"> keyword </code><code class="keyword">in</code><code class="plain"> </code><code class="functions">file</code><code class="plain">:</code></div>
<div class="line"><code class="plain">                            match </code><code class="keyword">=</code><code class="plain"> re.</code><code class="functions">compile</code><code class="plain">(r</code><code class="string">'_(\d+)_'</code><code class="plain">).search(</code><code class="functions">file</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                            </code><code class="keyword">if</code><code class="plain"> match:</code></div>
<div class="line"><code class="plain">                                timestamp </code><code class="keyword">=</code><code class="plain"> </code><code class="functions">int</code><code class="plain">(match.group(</code><code class="value">1</code><code class="plain">))</code></div>
<div class="line"><code class="plain">                                </code><code class="keyword">if</code><code class="plain"> timestamp > latest_files[keyword][</code><code class="string">'timestamp'</code><code class="plain">]:</code></div>
<div class="line"><code class="plain">                                    latest_files[keyword][</code><code class="string">'timestamp'</code><code class="plain">] </code><code class="keyword">=</code><code class="plain"> timestamp</code></div>
<div class="line"><code class="plain">                                    latest_files[keyword][</code><code class="string">'path'</code><code class="plain">] </code><code class="keyword">=</code><code class="plain"> os.path.join(root, </code><code class="functions">file</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">for</code><code class="plain"> keyword, info </code><code class="keyword">in</code><code class="plain"> latest_files.items():</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">if</code><code class="plain"> info[</code><code class="string">'path'</code><code class="plain">]:</code></div>
<div class="line"><code class="plain">                    shutil.copy(info[</code><code class="string">'path'</code><code class="plain">], os.path.join(output_path, vin, </code><code class="string">'bev'</code><code class="plain">, convert_filename(keyword)))</code></div>
<div class="line"><code class="plain">    </code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">def</code><code class="plain"> main():</code></div>
<div class="line"><code class="plain">    parser </code><code class="keyword">=</code><code class="plain"> argparse.ArgumentParser()</code></div>
<div class="line"><code class="plain">    parser.add_argument(</code><code class="string">'-p'</code><code class="plain">, </code><code class="string">'--data_path'</code><code class="plain">, required</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">, </code><code class="functions">type</code><code class="keyword">=</code><code class="functions">str</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    parser.add_argument(</code><code class="string">'-d'</code><code class="plain">, </code><code class="string">'--dump_path'</code><code class="plain">, required</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">, </code><code class="functions">type</code><code class="keyword">=</code><code class="functions">str</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    parser.add_argument(</code><code class="string">'-o'</code><code class="plain">, </code><code class="string">'--output_path'</code><code class="plain">, required</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">, </code><code class="functions">type</code><code class="keyword">=</code><code class="functions">str</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    args </code><code class="keyword">=</code><code class="plain"> parser.parse_args()</code></div>
<div class="line"><code class="plain">    data_path </code><code class="keyword">=</code><code class="plain"> args.data_path </code></div>
<div class="line"><code class="plain">    check_rostopic(data_path)</code></div>
<div class="line"><code class="plain">    find_offline_calib(data_path, args.dump_path, args.output_path)</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">if</code><code class="plain"> __name__ </code><code class="keyword">=</code><code class="keyword">=</code><code class="plain"> </code><code class="string">"__main__"</code><code class="plain">:</code></div>
<div class="line"><code class="plain">    main()</code></div>
</div>
    </div>
<p   
><br/></p>
<p   
> Example of processing results </p>
<ul class=" "><li class=" "><p   
> Rostopic information of each data package </p>
</li><li class=" "><p   
> The same car will record multiple data packets, record the timestamp information and transform into a readable mode </p>
</li><li class=" "><p   
> → Find Vin in DUMP_PATH indicates that the production line or after -sales calibration parameters of this car can be found, and you cannot find it temporarily </p>
</li></ul><p   
><img  class="confluence-embedded-image"  src="images/confluence/download/attachments/4416914771/image-2024-6-26_17-59-30-version-1-modificationdate-1719395972000-api-v2.png" alt="images/confluence/download/attachments/4416914771/image-2024-6-26_17-59-30-version-1-modificationdate-1719395972000-api-v2.png"  height="150" />
    </p>
<ul class=" "><li class=" "><p   
> Search the calibration data from the DUMP data according to the VIN code, extract and convert it into a standard format </p>
</li></ul><p   
><img  class="confluence-embedded-image"  src="images/confluence/download/attachments/4416914771/image-2024-6-26_18-7-11-version-1-modificationdate-1719396432000-api-v2.png" alt="images/confluence/download/attachments/4416914771/image-2024-6-26_18-7-11-version-1-modificationdate-1719396432000-api-v2.png"  height="400" />
<img  class="confluence-embedded-image"  src="images/confluence/download/attachments/4416914771/image-2024-6-26_18-9-9-version-1-modificationdate-1719396550000-api-v2.png" alt="images/confluence/download/attachments/4416914771/image-2024-6-26_18-9-9-version-1-modificationdate-1719396550000-api-v2.png"  height="400" />
<img  class="confluence-embedded-image"  src="images/confluence/download/attachments/4416914771/image-2024-6-26_18-25-44-version-1-modificationdate-1719397545000-api-v2.png" alt="images/confluence/download/attachments/4416914771/image-2024-6-26_18-25-44-version-1-modificationdate-1719397545000-api-v2.png"  height="190" />
</p>
    </div>
    <div class="section section-1" id="src-4416914771_safe-id-aWQt546v6KeG55u45py6QkVW5ou85o6l5pWw5o2u5YiG5p6Q5oyH5Y2X5YW85a65c2hhZG93X21vZGXjgIFwYXJraW5n44CB5Lqn57q_5qCH5a6a5ZKM5ZSu5ZCO5qCH5a6a5pWw5o2u5aSE55CGLeatpemqpOS6jO-8muS7jnJvc2JhZ-S4reaPkOWPlueOr-inhuebuOacuuWbvuWDj-WSjOagh-WumuWPguaVsA">
        <h1 class="heading "><span> Step 2: Extract the environmental camera image and calibration parameter from ROSBAG </span></h1>
<p   
> A single data: <span style="color: #ff0000;">
python3 extract_data_from_rosbag.py -r bag_file -o output_path    </span>
</p>
<ul class=" "><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;"> -R / BAG_FILE: Rosbag file path to be resolved </span>
    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;"> -O / output_path: parsing data output path </span>
<br/>    </span>
</p>
</li></ul><p   
> Batch processing: <span style="color: #ff0000;">
find rosbag_path -type f -name '*.bag' | xargs -I {} sh -c 'python3 extract_data_from_rosbag.py -r {} -o output_path'    </span>
</p>
<ul class=" "><li class=" "><p   
>    <span style="color: #000000;"> ROSBAG_PATH: Multiple ROSBAG folder paths to be parsed </span>
</p>
</li><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;"> -O / output_path: The data output path after parsing will be stored separately according to the ROSBAG name </span>
    </span>
</p>
</li></ul><p   
>    <span style="color: #ff0000;">
    <span style="color: #ff0000;"> python to be perfect: </span> At present, the calibration parameters are not available, and it has not been tested yet </span>
</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">extract_data_from_rosbag.py</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="extract_data_from_rosbag.py" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="keyword">import</code><code class="plain"> os</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> cv2</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> rosbag</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> argparse</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> numpy as np</code></div>
<div class="line"><code class="keyword">from</code><code class="plain"> pathlib </code><code class="keyword">import</code><code class="plain"> Path</code></div>
<div class="line"><code class="keyword">from</code><code class="plain"> cv_bridge </code><code class="keyword">import</code><code class="plain"> CvBridge</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">IMAGE_WIDTH </code><code class="keyword">=</code><code class="plain"> </code><code class="value">1920</code></div>
<div class="line"><code class="plain">IMAGE_HEIGHT </code><code class="keyword">=</code><code class="plain"> </code><code class="value">1536</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">def</code><code class="plain"> get_sensor_calib_parameter(topic_dir, message):</code></div>
<div class="line"><code class="plain">    sensor_ids </code><code class="keyword">=</code><code class="plain"> [</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_NOT_SUPPORT"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_IMU"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_FRONT_LIDAR"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_LEFT_LIDAR"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_RIGHT_LIDAR"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_SIDE_VIEW_CAMERA_FRONT_TELE"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_SIDE_VIEW_CAMERA_FRONT_WIDE"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_SIDE_VIEW_CAMERA_FRONT_LEFT"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_SIDE_VIEW_CAMERA_FRONT_RIGHT"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_SIDE_VIEW_CAMERA_REAR_LEFT"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_SIDE_VIEW_CAMERA_REAR_RIGHT"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_SIDE_VIEW_CAMERA_REAR"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_SURROUND_VIEW_CAMERA_FRONT"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_SURROUND_VIEW_CAMERA_REAR"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_SURROUND_VIEW_CAMERA_LEFT"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_SURROUND_VIEW_CAMERA_RIGHT"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    ]</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    nrcs_map </code><code class="keyword">=</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_SURROUND_VIEW_CAMERA_FRONT"</code><code class="plain">: </code><code class="string">"nrcs_front.yaml"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_SURROUND_VIEW_CAMERA_REAR"</code><code class="plain">: </code><code class="string">"nrcs_rear.yaml"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_SURROUND_VIEW_CAMERA_LEFT"</code><code class="plain">: </code><code class="string">"nrcs_left.yaml"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"SI_SURROUND_VIEW_CAMERA_RIGHT"</code><code class="plain">: </code><code class="string">"nrcs_right.yaml"</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    fs </code><code class="keyword">=</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">        key: cv2.FileStorage(os.path.join(topic_dir, nrcs_map[key]), cv2.FILE_STORAGE_WRITE)</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">for</code><code class="plain"> key </code><code class="keyword">in</code><code class="plain"> nrcs_map</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">try</code><code class="plain">:</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">for</code><code class="plain"> index, sensor_id </code><code class="keyword">in</code><code class="plain"> </code><code class="functions">enumerate</code><code class="plain">(message.sensorxxtrinsic_sensor_ids):</code></div>
<div class="line"><code class="plain">            sensor_name </code><code class="keyword">=</code><code class="plain"> sensor_ids[sensor_id]</code></div>
<div class="line"><code class="plain">            sensor_intrinsic </code><code class="keyword">=</code><code class="plain"> message.sensorxxtrinsic_sensor_intrinsics[index]</code></div>
<div class="line"><code class="plain">            sensor_extrinsic </code><code class="keyword">=</code><code class="plain"> message.sensorxxtrinsic_sensor_extrinsics[index]</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">            </code><code class="keyword">if</code><code class="plain"> sensor_name </code><code class="keyword">in</code><code class="plain"> fs:</code></div>
<div class="line"><code class="plain">                camera_name </code><code class="keyword">=</code><code class="plain"> </code><code class="string">"nrcs_"</code><code class="plain"> </code><code class="keyword">+</code><code class="plain"> sensor_name.split(</code><code class="string">'_'</code><code class="plain">)[</code><code class="keyword">-</code><code class="value">1</code><code class="plain">].lower()</code></div>
<div class="line"><code class="plain">                poly_param </code><code class="keyword">=</code><code class="plain"> {f</code><code class="string">"p{i}"</code><code class="plain">: sensor_intrinsic.cameraintrinsic_parameters[i </code><code class="keyword">+</code><code class="plain"> </code><code class="value">3</code><code class="plain">] </code><code class="keyword">for</code><code class="plain"> i </code><code class="keyword">in</code><code class="plain"> </code><code class="functions">range</code><code class="plain">(</code><code class="value">5</code><code class="plain">)}</code></div>
<div class="line"><code class="plain">                inv_poly_param </code><code class="keyword">=</code><code class="plain"> {f</code><code class="string">"p{i}"</code><code class="plain">: sensor_intrinsic.cameraintrinsic_parameters[i </code><code class="keyword">+</code><code class="plain"> </code><code class="value">8</code><code class="plain">] </code><code class="keyword">for</code><code class="plain"> i </code><code class="keyword">in</code><code class="plain"> </code><code class="functions">range</code><code class="plain">(</code><code class="value">20</code><code class="plain">)}</code></div>
<div class="line"><code class="plain">                affine_param </code><code class="keyword">=</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">                    </code><code class="string">"ac"</code><code class="plain">: sensor_intrinsic.cameraintrinsic_parameters[</code><code class="value">0</code><code class="plain">],</code></div>
<div class="line"><code class="plain">                    </code><code class="string">"ad"</code><code class="plain">: sensor_intrinsic.cameraintrinsic_parameters[</code><code class="value">1</code><code class="plain">],</code></div>
<div class="line"><code class="plain">                    </code><code class="string">"ae"</code><code class="plain">: sensor_intrinsic.cameraintrinsic_parameters[</code><code class="value">2</code><code class="plain">],</code></div>
<div class="line"><code class="plain">                    </code><code class="string">"cx"</code><code class="plain">: sensor_intrinsic.cameraintrinsic_cx,</code></div>
<div class="line"><code class="plain">                    </code><code class="string">"cy"</code><code class="plain">: sensor_intrinsic.cameraintrinsic_cy</code></div>
<div class="line"><code class="plain">                }</code></div>
<div class="line"><code class="plain">                extrinsic_transform </code><code class="keyword">=</code><code class="plain"> np.array(sensor_extrinsic.sensorextrinsic_transform).reshape(</code><code class="value">4</code><code class="plain">, </code><code class="value">4</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">try</code><code class="plain">:</code></div>
<div class="line"><code class="plain">                    fs.write(</code><code class="string">"model_type"</code><code class="plain">, </code><code class="string">"SCARAMUZZA"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                    fs.write(</code><code class="string">"camera_name"</code><code class="plain">, camera_name)</code></div>
<div class="line"><code class="plain">                    fs.write(</code><code class="string">"image_width"</code><code class="plain">,  sensor_intrinsic.cameraintrinsic_width)</code></div>
<div class="line"><code class="plain">                    fs.write(</code><code class="string">"image_height"</code><code class="plain">, sensor_intrinsic.cameraintrinsic_height)</code></div>
<div class="line"><code class="plain">                    fs.startWriteStruct(</code><code class="string">"poly_parameters"</code><code class="plain">, cv2.FileNode_MAP)</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">for</code><code class="plain"> key, value </code><code class="keyword">in</code><code class="plain"> poly_param.items():</code></div>
<div class="line"><code class="plain">                        fs.write(key, value)</code></div>
<div class="line"><code class="plain">                    fs.endWriteStruct()</code></div>
<div class="line"><code class="plain">                    fs.startWriteStruct(</code><code class="string">"inv_poly_parameters"</code><code class="plain">, cv2.FileNode_MAP)</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">for</code><code class="plain"> key, value </code><code class="keyword">in</code><code class="plain"> inv_poly_param.items():</code></div>
<div class="line"><code class="plain">                        fs.write(key, value)</code></div>
<div class="line"><code class="plain">                    fs.endWriteStruct()</code></div>
<div class="line"><code class="plain">                    fs.startWriteStruct(</code><code class="string">"affine_parameters"</code><code class="plain">, cv2.FileNode_MAP)</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">for</code><code class="plain"> key, value </code><code class="keyword">in</code><code class="plain"> affine_param.items():</code></div>
<div class="line"><code class="plain">                        fs.write(key, value)</code></div>
<div class="line"><code class="plain">                    fs.endWriteStruct()</code></div>
<div class="line"><code class="plain">                    fs.write(</code><code class="string">"T_v_c"</code><code class="plain">, np.array(extrinsic_transform).reshape(</code><code class="value">4</code><code class="plain">, </code><code class="value">4</code><code class="plain">))</code></div>
<div class="line"><code class="plain">                    fs.write(</code><code class="string">"comment"</code><code class="plain">,topic_dir)</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">except</code><code class="plain"> Exception as e:</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">print</code><code class="plain">(f</code><code class="string">"[ERROR] fail to write sensor_calib_parameter: {e}"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">finally</code><code class="plain">:</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">for</code><code class="plain"> fs </code><code class="keyword">in</code><code class="plain"> fs.values():</code></div>
<div class="line"><code class="plain">            fs.release()</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">def</code><code class="plain"> get_nrcs_image(topic_dir, message, timestamp):</code></div>
<div class="line"><code class="plain">    img </code><code class="keyword">=</code><code class="plain"> </code><code class="color1">None</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">if</code><code class="plain"> message._type </code><code class="keyword">=</code><code class="keyword">=</code><code class="plain"> </code><code class="string">"sensor_msgs/CompressedImage"</code><code class="plain">:</code></div>
<div class="line"><code class="plain">        bridge </code><code class="keyword">=</code><code class="plain"> CvBridge()</code></div>
<div class="line"><code class="plain">        img </code><code class="keyword">=</code><code class="plain"> bridge.compressed_imgmsg_to_cv2(message, </code><code class="string">"bgr8"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">elif</code><code class="plain"> message._type </code><code class="keyword">=</code><code class="keyword">=</code><code class="plain"> </code><code class="string">"raloctld/CameraImage"</code><code class="plain">:</code></div>
<div class="line"><code class="plain">        image_np </code><code class="keyword">=</code><code class="plain"> np.frombuffer(message.imageData, np.uint8)</code></div>
<div class="line"><code class="plain">        img </code><code class="keyword">=</code><code class="plain"> cv2.imdecode(image_np, cv2.IMREAD_COLOR)</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">else</code><code class="plain">:</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">raise</code><code class="plain"> SystemExit</code></div>
<div class="line"><code class="plain">    img_resize </code><code class="keyword">=</code><code class="plain"> cv2.resize(img, (IMAGE_WIDTH, IMAGE_HEIGHT))</code></div>
<div class="line"><code class="plain">    cv2.imwrite(os.path.join(topic_dir, </code><code class="functions">str</code><code class="plain">(timestamp) </code><code class="keyword">+</code><code class="plain"> </code><code class="string">".jpg"</code><code class="plain">), img_resize)</code></div>
<div class="line"><code class="plain">    </code></div>
<div class="line"><code class="plain">    </code></div>
<div class="line"><code class="keyword">def</code><code class="plain"> main(rosbag_file, output_path):</code></div>
<div class="line"><code class="plain">    with rosbag.Bag(rosbag_file, </code><code class="string">'r'</code><code class="plain">) as bag:</code></div>
<div class="line"><code class="plain">        topics </code><code class="keyword">=</code><code class="plain"> bag.get_type_and_topic_info()[</code><code class="value">1</code><code class="plain">].keys()</code></div>
<div class="line"><code class="plain">    nrcs_rostopic </code><code class="keyword">=</code><code class="plain"> [topic.split(</code><code class="string">'/'</code><code class="plain">)[</code><code class="keyword">-</code><code class="value">1</code><code class="plain">].split(</code><code class="string">'NearRange'</code><code class="plain">)[</code><code class="keyword">-</code><code class="value">1</code><code class="plain">] </code><code class="keyword">for</code><code class="plain"> topic </code><code class="keyword">in</code><code class="plain"> topics </code><code class="keyword">if</code><code class="plain"> topic.startswith(</code><code class="string">'/C/Camera/NearRange'</code><code class="plain">)]</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">print</code><code class="plain">(f</code><code class="string">'nrcs_rostopic: {nrcs_rostopic}'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">for</code><code class="plain"> camera </code><code class="keyword">in</code><code class="plain"> [</code><code class="string">'Front'</code><code class="plain">, </code><code class="string">'Rear'</code><code class="plain">, </code><code class="string">'Left'</code><code class="plain">, </code><code class="string">'Right'</code><code class="plain">]:</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> camera </code><code class="keyword">not</code><code class="plain"> </code><code class="keyword">in</code><code class="plain"> nrcs_rostopic:</code></div>
<div class="line"><code class="plain">            img_black </code><code class="keyword">=</code><code class="plain"> np.zeros((IMAGE_WIDTH, IMAGE_HEIGHT, </code><code class="value">3</code><code class="plain">), dtype</code><code class="keyword">=</code><code class="plain">np.uint8)</code></div>
<div class="line"><code class="plain">            cv2.imwrite(os.path.join(output_path, f</code><code class="string">'nrcs_{camera.lower()}.jpg'</code><code class="plain">), img_black)</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    bag </code><code class="keyword">=</code><code class="plain"> rosbag.Bag(rosbag_file)</code></div>
<div class="line"><code class="plain">    topics </code><code class="keyword">=</code><code class="plain"> [</code></div>
<div class="line"><code class="plain">        </code><code class="string">"/C/Camera/NearRangeFront"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"/C/Camera/NearRangeLeft"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"/C/Camera/NearRangeRear"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"/C/Camera/NearRangeRight"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="comments">#"/A/ara_com_gateway/sensor_calib_parameter_senderport",</code></div>
<div class="line"><code class="plain">        </code><code class="comments">#"/A/ara_com_gateway_slave/sensor_calib_parameter_senderport",</code></div>
<div class="line"><code class="plain">        </code><code class="comments">#"/A/ara_com_gateway/online_sensor_calib_parameter_senderport",</code></div>
<div class="line"><code class="plain">    ]</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">try</code><code class="plain">:</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">for</code><code class="plain"> topic, message, timestamp </code><code class="keyword">in</code><code class="plain"> bag.read_messages(topics</code><code class="keyword">=</code><code class="plain">topics):</code></div>
<div class="line"><code class="plain">            topic_dir </code><code class="keyword">=</code><code class="plain"> os.path.join(output_path, Path(rosbag_file).stem, topic.replace(</code><code class="string">"/"</code><code class="plain">, </code><code class="string">"_"</code><code class="plain">))</code></div>
<div class="line"><code class="plain">            os.makedirs(topic_dir, exist_ok</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            </code><code class="comments"># -- TODO</code></div>
<div class="line"><code class="plain">            </code><code class="comments">#if "sensor_calib_parameter_senderport" in topic:</code></div>
<div class="line"><code class="plain">            </code><code class="comments">#    get_sensor_calib_parameter(topic_dir, message)</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">if</code><code class="plain"> </code><code class="string">"/C/Camera/NearRange"</code><code class="plain"> </code><code class="keyword">in</code><code class="plain"> topic:</code></div>
<div class="line"><code class="plain">                get_nrcs_image(topic_dir, message, timestamp)</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">finally</code><code class="plain">:</code></div>
<div class="line"><code class="plain">        bag.close()</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">if</code><code class="plain"> __name__ </code><code class="keyword">=</code><code class="keyword">=</code><code class="plain"> </code><code class="string">"__main__"</code><code class="plain">:</code></div>
<div class="line"><code class="plain">    parser </code><code class="keyword">=</code><code class="plain"> argparse.ArgumentParser()</code></div>
<div class="line"><code class="plain">    parser.add_argument(</code><code class="string">'-r'</code><code class="plain">, </code><code class="string">'--rosbag_file'</code><code class="plain">, required</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">, </code><code class="functions">type</code><code class="keyword">=</code><code class="functions">str</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    parser.add_argument(</code><code class="string">'-o'</code><code class="plain">, </code><code class="string">'--output_path'</code><code class="plain">, required</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">, </code><code class="functions">type</code><code class="keyword">=</code><code class="functions">str</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    args </code><code class="keyword">=</code><code class="plain"> parser.parse_args()</code></div>
<div class="line"><code class="plain">    main(args.rosbag_file, args.output_path)</code></div>
</div>
    </div>
    </div>
    <div class="section section-1" id="src-4416914771_safe-id-aWQt546v6KeG55u45py6QkVW5ou85o6l5pWw5o2u5YiG5p6Q5oyH5Y2X5YW85a65c2hhZG93X21vZGXjgIFwYXJraW5n44CB5Lqn57q_5qCH5a6a5ZKM5ZSu5ZCO5qCH5a6a5pWw5o2u5aSE55CGLeatpemqpOS4ie-8muWfuuS6juaXtumXtOaIs-WQjOatpTTot6_njq_op4bnm7jmnLrlm77lg48">
        <h1 class="heading "><span> Step 3: Based on timestamp synchronization 4 -way environmental camera image </span></h1>
<p   
> A single data: <span style="color: #ff0000;">
python3 sync_parking_data_by_timestamp.py -d chery -i image_path -o output_path    </span>
    <span style="color: #ff0000;">
    <span style="color: #000000;">
<br/>    </span>
    </span>
</p>
<ul class=" "><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;"> -d / data_type: Data type <span style="color: #ff0000;">
    <span style="color: #000000;">
chery/parking    </span>
    </span>
    </span>
    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;"> -I / Image_path: The path where the original image is located (step 2 generation) </span>
    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;"> -O / output_path: parsing data output path </span>
<br/>    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;"> -t / TimestAmp_front: Optional parameters, if you choose manually, enter the timestamp of the front -view camera (image name, without suffix) </span>
    </span>
</p>
</li></ul><p   
> Batch processing: <span style="color: #ff0000;">
find     <span style="color: #ff0000;">
image_path    </span>
 -mindepth 1 -maxdepth 1 -type d -exec python3 sync_parking_data_by_timestamp.py -d chery -i {} -o /home/fih1szh/Downloads/shadow_mode/data/output \;    </span>
</p>
<ul class=" "><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;">
image_path：    <span style="color: #ff0000;">
    <span style="color: #000000;"> The path of the original image of multiple cars </span>
    </span>
<br/>    </span>
    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;"> -d / data_type: Data type <span style="color: #ff0000;">
    <span style="color: #000000;">
chery/parking    </span>
    </span>
    </span>
    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;"> -O / OUTPUT_PATH: Analysis of data output paths, <span style="color: #ff0000;">
    <span style="color: #000000;"> Will be stored separately by vin </span>
    </span>
    </span>
    </span>
</p>
</li></ul><p   
>    <span style="color: #ff0000;"> Python is waiting to be perfected: At present, the image of the front vision camera is sorted by time stamp, and one quarter, one -half, and three -quarters of the 3 -frame data synchronize the other three -way cameras.good <br/>    </span>
</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">sync_parking_data_by_timestamp.py</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="sync_parking_data_by_timestamp.py" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="keyword">import</code><code class="plain"> os</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> re</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> shutil</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> argparse</code></div>
<div class="line"><code class="keyword">from</code><code class="plain"> pathlib </code><code class="keyword">import</code><code class="plain"> Path</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">def</code><code class="plain"> extract_timestamps(directory):</code></div>
<div class="line"><code class="plain">    jpg_files </code><code class="keyword">=</code><code class="plain"> </code><code class="functions">sorted</code><code class="plain">(Path(directory).glob(</code><code class="string">'*.jpg'</code><code class="plain">), key</code><code class="keyword">=</code><code class="keyword">lambda</code><code class="plain"> x: </code><code class="functions">int</code><code class="plain">(x.stem))</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">if</code><code class="plain"> </code><code class="functions">len</code><code class="plain">(jpg_files) > </code><code class="value">3</code><code class="plain">:</code></div>
<div class="line"><code class="plain">        quarter_timestamp </code><code class="keyword">=</code><code class="plain"> </code><code class="functions">int</code><code class="plain">(jpg_files[</code><code class="functions">len</code><code class="plain">(jpg_files) </code><code class="keyword">/</code><code class="keyword">/</code><code class="plain"> </code><code class="value">4</code><code class="plain">].stem)</code></div>
<div class="line"><code class="plain">        half_timestamp </code><code class="keyword">=</code><code class="plain"> </code><code class="functions">int</code><code class="plain">(jpg_files[</code><code class="functions">len</code><code class="plain">(jpg_files) </code><code class="keyword">/</code><code class="keyword">/</code><code class="plain"> </code><code class="value">2</code><code class="plain">].stem)</code></div>
<div class="line"><code class="plain">        three_quarter_timestamp </code><code class="keyword">=</code><code class="plain"> </code><code class="functions">int</code><code class="plain">(jpg_files[</code><code class="value">3</code><code class="plain"> </code><code class="keyword">*</code><code class="plain"> </code><code class="functions">len</code><code class="plain">(jpg_files) </code><code class="keyword">/</code><code class="keyword">/</code><code class="plain"> </code><code class="value">4</code><code class="plain">].stem)</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> quarter_timestamp, half_timestamp, three_quarter_timestamp</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">else</code><code class="plain">:</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">raise</code><code class="plain"> ValueError(</code><code class="string">"[ERROR] fail to gernerate parking data"</code><code class="plain">)</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">def</code><code class="plain"> find_nearest_image(directory, timestamp_front):</code></div>
<div class="line"><code class="plain">    nearest_file </code><code class="keyword">=</code><code class="plain"> </code><code class="color1">None</code></div>
<div class="line"><code class="plain">    nearest_diff </code><code class="keyword">=</code><code class="plain"> </code><code class="functions">float</code><code class="plain">(</code><code class="string">'inf'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">for</code><code class="plain"> </code><code class="functions">file</code><code class="plain"> </code><code class="keyword">in</code><code class="plain"> os.listdir(directory):</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> </code><code class="functions">file</code><code class="plain">.endswith(</code><code class="string">'.jpg'</code><code class="plain">):</code></div>
<div class="line"><code class="plain">            timestamp_str </code><code class="keyword">=</code><code class="plain"> </code><code class="functions">file</code><code class="plain">.split(</code><code class="string">'.jpg'</code><code class="plain">)[</code><code class="value">0</code><code class="plain">]</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">try</code><code class="plain">:</code></div>
<div class="line"><code class="plain">                timestamp </code><code class="keyword">=</code><code class="plain"> </code><code class="functions">float</code><code class="plain">(timestamp_str)</code></div>
<div class="line"><code class="plain">                diff </code><code class="keyword">=</code><code class="plain"> </code><code class="functions">abs</code><code class="plain">(timestamp </code><code class="keyword">-</code><code class="plain"> timestamp_front)</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">if</code><code class="plain"> diff < nearest_diff:</code></div>
<div class="line"><code class="plain">                    nearest_diff </code><code class="keyword">=</code><code class="plain"> diff</code></div>
<div class="line"><code class="plain">                    nearest_file </code><code class="keyword">=</code><code class="plain"> </code><code class="functions">file</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">except</code><code class="plain"> ValueError:</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">continue</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain"> nearest_file, nearest_diff</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">def</code><code class="plain"> data_sync(data_type, image_path, timestamp_front, output_path):</code></div>
<div class="line"><code class="plain">    image_to_path </code><code class="keyword">=</code><code class="plain"> </code><code class="color1">None</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">if</code><code class="plain"> data_type </code><code class="keyword">=</code><code class="keyword">=</code><code class="plain"> </code><code class="string">'bosch'</code><code class="plain">: </code><code class="comments"># -- parking data</code></div>
<div class="line"><code class="plain">        image_to_path </code><code class="keyword">=</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">            </code><code class="string">"nrcs_front.jpg"</code><code class="plain">: </code><code class="string">"C/Camera/NearRangeFront"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">            </code><code class="string">"nrcs_rear.jpg"</code><code class="plain">: </code><code class="string">"C/Camera/NearRangeRear"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">            </code><code class="string">"nrcs_left.jpg"</code><code class="plain">: </code><code class="string">"C/Camera/NearRangeLeft"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">            </code><code class="string">"nrcs_right.jpg"</code><code class="plain">: </code><code class="string">"C/Camera/NearRangeRight"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        }    </code></div>
<div class="line"><code class="plain">    </code><code class="keyword">elif</code><code class="plain"> data_type </code><code class="keyword">=</code><code class="keyword">=</code><code class="plain"> </code><code class="string">'chery'</code><code class="plain">: </code><code class="comments"># -- shadow_mode data</code></div>
<div class="line"><code class="plain">        image_to_path </code><code class="keyword">=</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">            </code><code class="string">"nrcs_front.jpg"</code><code class="plain">: </code><code class="string">"_C_Camera_NearRangeFront"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">            </code><code class="string">"nrcs_rear.jpg"</code><code class="plain">: </code><code class="string">"_C_Camera_NearRangeRear"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">            </code><code class="string">"nrcs_left.jpg"</code><code class="plain">: </code><code class="string">"_C_Camera_NearRangeLeft"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">            </code><code class="string">"nrcs_right.jpg"</code><code class="plain">: </code><code class="string">"_C_Camera_NearRangeRight"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        } </code></div>
<div class="line"><code class="plain">    </code><code class="keyword">else</code><code class="plain">:</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    match </code><code class="keyword">=</code><code class="plain"> re.search(r</code><code class="string">'2_[^_]*_[^_]*_(\w+)_'</code><code class="plain">, image_path)</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">if</code><code class="plain"> match:</code></div>
<div class="line"><code class="plain">        vin </code><code class="keyword">=</code><code class="plain"> match.group(</code><code class="value">1</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">print</code><code class="plain">(f</code><code class="string">'generate parking data of {vin}'</code><code class="plain">)</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    vin_path </code><code class="keyword">=</code><code class="plain"> Path(output_path) </code><code class="keyword">/</code><code class="plain"> vin</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">if</code><code class="plain"> vin_path.exists() </code><code class="keyword">and</code><code class="plain"> vin_path.is_dir():</code></div>
<div class="line"><code class="plain">        parking_path </code><code class="keyword">=</code><code class="plain"> vin_path </code><code class="keyword">/</code><code class="plain"> </code><code class="string">'parking'</code></div>
<div class="line"><code class="plain">        parking_path.mkdir(parents</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">, exist_ok</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">else</code><code class="plain">:</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">print</code><code class="plain">(f</code><code class="string">"offline_calib of {vin} is not exist."</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code></div>
<div class="line"><code class="plain">    </code></div>
<div class="line"><code class="plain">    front_timestamps </code><code class="keyword">=</code><code class="plain"> []</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">if</code><code class="plain"> </code><code class="keyword">not</code><code class="plain"> timestamp_front:</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> data_type </code><code class="keyword">=</code><code class="keyword">=</code><code class="plain"> </code><code class="string">'bosch'</code><code class="plain">:</code></div>
<div class="line"><code class="plain">            front_timestamps </code><code class="keyword">=</code><code class="plain"> extract_timestamps(Path(image_path) </code><code class="keyword">/</code><code class="plain"> </code><code class="string">"C/Camera/NearRangeFront"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">elif</code><code class="plain"> data_type </code><code class="keyword">=</code><code class="keyword">=</code><code class="plain"> </code><code class="string">'chery'</code><code class="plain">:</code></div>
<div class="line"><code class="plain">            front_timestamps </code><code class="keyword">=</code><code class="plain"> extract_timestamps(Path(image_path) </code><code class="keyword">/</code><code class="plain"> </code><code class="string">"_C_Camera_NearRangeFront"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">else</code><code class="plain">:</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">return</code><code class="plain">        </code></div>
<div class="line"><code class="plain">    </code><code class="keyword">else</code><code class="plain">:</code></div>
<div class="line"><code class="plain">        front_timestamps.append(timestamp_front)</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="keyword">for</code><code class="plain"> index, ft </code><code class="keyword">in</code><code class="plain"> </code><code class="functions">enumerate</code><code class="plain">(front_timestamps):</code></div>
<div class="line"><code class="plain">        parking_path </code><code class="keyword">=</code><code class="plain"> vin_path </code><code class="keyword">/</code><code class="plain"> f</code><code class="string">'parking/{index}'</code></div>
<div class="line"><code class="plain">        parking_path.mkdir(parents</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">, exist_ok</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        log_file </code><code class="keyword">=</code><code class="plain"> parking_path </code><code class="keyword">/</code><code class="plain"> </code><code class="string">"image_timestamp.txt"</code></div>
<div class="line"><code class="plain">        with </code><code class="functions">open</code><code class="plain">(log_file, </code><code class="string">'w'</code><code class="plain">) as log:</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">for</code><code class="plain"> new_name, relative_path </code><code class="keyword">in</code><code class="plain"> image_to_path.items():</code></div>
<div class="line"><code class="plain">                camera_dir </code><code class="keyword">=</code><code class="plain"> Path(image_path) </code><code class="keyword">/</code><code class="plain"> relative_path.lstrip(</code><code class="string">'/'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">if</code><code class="plain"> new_name </code><code class="keyword">=</code><code class="keyword">=</code><code class="plain"> </code><code class="string">"nrcs_front.jpg"</code><code class="plain">:</code></div>
<div class="line"><code class="plain">                    src_file </code><code class="keyword">=</code><code class="plain"> camera_dir </code><code class="keyword">/</code><code class="plain"> f</code><code class="string">"{ft}.jpg"</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">if</code><code class="plain"> src_file.exists():</code></div>
<div class="line"><code class="plain">                        shutil.copy2(src_file, parking_path </code><code class="keyword">/</code><code class="plain"> new_name)</code></div>
<div class="line"><code class="plain">                        log.write(f</code><code class="string">"{src_file.name}\n"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">else</code><code class="plain">:</code></div>
<div class="line"><code class="plain">                        log.write(f</code><code class="string">"{src_file.name} not found\n"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">else</code><code class="plain">:</code></div>
<div class="line"><code class="plain">                    nearest_file, nearest_diff </code><code class="keyword">=</code><code class="plain"> find_nearest_image(camera_dir, </code><code class="functions">float</code><code class="plain">(ft))</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">if</code><code class="plain"> nearest_file:</code></div>
<div class="line"><code class="plain">                        src_file </code><code class="keyword">=</code><code class="plain"> camera_dir </code><code class="keyword">/</code><code class="plain"> nearest_file</code></div>
<div class="line"><code class="plain">                        shutil.copy2(src_file, parking_path </code><code class="keyword">/</code><code class="plain"> new_name)</code></div>
<div class="line"><code class="plain">                        log.write(f</code><code class="string">"{nearest_file} diff:{nearest_diff / 1_000_000_000:.3f}(second)\n"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">else</code><code class="plain">:</code></div>
<div class="line"><code class="plain">                        log.write(f</code><code class="string">"not found\n"</code><code class="plain">)</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">def</code><code class="plain"> main():</code></div>
<div class="line"><code class="plain">    parser </code><code class="keyword">=</code><code class="plain"> argparse.ArgumentParser(description</code><code class="keyword">=</code><code class="string">"generate parking data"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    parser.add_argument(</code><code class="string">'-d'</code><code class="plain">, </code><code class="string">'--data_type'</code><code class="plain">, required</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">, default</code><code class="keyword">=</code><code class="string">'chery'</code><code class="plain">, </code><code class="functions">type</code><code class="keyword">=</code><code class="functions">str</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    parser.add_argument(</code><code class="string">'-i'</code><code class="plain">, </code><code class="string">'--image_path'</code><code class="plain">, required</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">, </code><code class="functions">type</code><code class="keyword">=</code><code class="functions">str</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    parser.add_argument(</code><code class="string">'-t'</code><code class="plain">, </code><code class="string">'--timestamp_front'</code><code class="plain">, required</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">, </code><code class="functions">type</code><code class="keyword">=</code><code class="functions">str</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    parser.add_argument(</code><code class="string">'-o'</code><code class="plain">, </code><code class="string">'--output_path'</code><code class="plain">, required</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">, </code><code class="functions">type</code><code class="keyword">=</code><code class="functions">str</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    args </code><code class="keyword">=</code><code class="plain"> parser.parse_args()</code></div>
<div class="line"><code class="plain">    data_sync(args.data_type, args.image_path, args.timestamp_front, args.output_path)</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">if</code><code class="plain"> __name__ </code><code class="keyword">=</code><code class="keyword">=</code><code class="plain"> </code><code class="string">"__main__"</code><code class="plain">:</code></div>
<div class="line"><code class="plain">    main()</code></div>
</div>
    </div>
<p   
> Example of processing results </p>
<p   
> The original timestamp and difference between the 4 -way fish eye camera image and the difference between the FRONT <span style="color: #ff0000;"> (If the stitching effect is not good, check whether it is caused by different splicing) </span>
</p>
<p   
><img  class="confluence-embedded-image confluence-thumbnail"  src="images/confluence/download/thumbnails/4416914771/image-2024-6-27_16-52-13-version-1-modificationdate-1719478334000-api-v2.png" alt="images/confluence/download/thumbnails/4416914771/image-2024-6-27_16-52-13-version-1-modificationdate-1719478334000-api-v2.png"  height="250" />
<img  class="confluence-embedded-image"  src="images/confluence/download/attachments/4416914771/image-2024-6-27_16-52-52-version-1-modificationdate-1719478372000-api-v2.png" alt="images/confluence/download/attachments/4416914771/image-2024-6-27_16-52-52-version-1-modificationdate-1719478372000-api-v2.png"  height="71" />
</p>
    </div>
    <div class="section section-1" id="src-4416914771_safe-id-aWQt546v6KeG55u45py6QkVW5ou85o6l5pWw5o2u5YiG5p6Q5oyH5Y2X5YW85a65c2hhZG93X21vZGXjgIFwYXJraW5n44CB5Lqn57q_5qCH5a6a5ZKM5ZSu5ZCO5qCH5a6a5pWw5o2u5aSE55CGLeatpemqpOWbm--8muagueaNruagh-WumuWPguaVsOeUn-aIkGJlduaLvOaOpeebuOWFs-aWh-S7tg">
        <h1 class="heading "><span> Step 4: Generate BEV stitching related files according to the calibration parameter </span></h1>
<p   
> A single data: <span style="color: #ff0000;">
python3 yaml_to_bev.py -y yaml_path<br/>    </span>
</p>
<ul class=" "><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;"> -y / yaml_path: The path of the yaml file is located (step -year generation) <br/>    </span>
    </span>
</p>
</li></ul><p   
> Batch processing: <span style="color: #ff0000;">
find yaml_path -mindepth 1 -maxdepth 1 -type d | xargs -I {} sh -c 'python3 yaml_to_bev.py -y {}/bev'    </span>
</p>
<ul class=" "><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;">
    <span style="color: #ff0000;">
    <span style="color: #000000;">
yaml_path    </span>
    </span>
：    <span style="color: #ff0000;">
    <span style="color: #000000;"> Multi -car <span style="color: #ff0000;">
    <span style="color: #000000;">
    <span style="color: #ff0000;">
    <span style="color: #000000;">
    <span style="color: #ff0000;">
    <span style="color: #000000;">
     </span>
    </span>
    </span>
    </span> yaml file </span>
    </span> Where the path is </span>
    </span>
    </span>
    </span>
    <span style="color: #ff0000;">
    <span style="color: #000000;">
，    <span style="color: #ff0000;">
    <span style="color: #000000;"> Will be stored separately by vin </span>
    </span>
    </span>
    </span>
</p>
</li></ul>    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="keyword">import</code><code class="plain"> os</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> re</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> cv2</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> yaml</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> argparse</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> numpy as np</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">def</code><code class="plain"> check_files_exist(yaml_path):</code></div>
<div class="line"><code class="plain">    is_all_exist </code><code class="keyword">=</code><code class="plain"> </code><code class="color1">True</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">for</code><code class="plain"> file_name </code><code class="keyword">in</code><code class="plain"> [</code><code class="string">'nrcs_front.yaml'</code><code class="plain">, </code><code class="string">'nrcs_right.yaml'</code><code class="plain">, </code><code class="string">'nrcs_rear.yaml'</code><code class="plain">, </code><code class="string">'nrcs_left.yaml'</code><code class="plain">]:</code></div>
<div class="line"><code class="plain">        file_path </code><code class="keyword">=</code><code class="plain"> os.path.join(yaml_path, file_name)</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> os.path.exists(file_path) </code><code class="keyword">is</code><code class="plain"> </code><code class="color1">False</code><code class="plain">:</code></div>
<div class="line"><code class="plain">            is_all_exist </code><code class="keyword">=</code><code class="plain"> </code><code class="color1">False</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain"> is_all_exist</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">def</code><code class="plain"> rename_files(yaml_path):</code></div>
<div class="line"><code class="plain">    pattern </code><code class="keyword">=</code><code class="plain"> re.</code><code class="functions">compile</code><code class="plain">(r</code><code class="string">'.*_nrcs_*_yaml_.*\.log$'</code><code class="plain">)    </code></div>
<div class="line"><code class="plain">    files_rename </code><code class="keyword">=</code><code class="plain"> []</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">for</code><code class="plain"> root, _, files </code><code class="keyword">in</code><code class="plain"> os.walk(yaml_path):</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">for</code><code class="plain"> </code><code class="functions">file</code><code class="plain"> </code><code class="keyword">in</code><code class="plain"> files:</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">if</code><code class="plain"> pattern.match(</code><code class="functions">file</code><code class="plain">):</code></div>
<div class="line"><code class="plain">                old_file_path </code><code class="keyword">=</code><code class="plain"> os.path.join(root, </code><code class="functions">file</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                new_file_path </code><code class="keyword">=</code><code class="plain"> os.path.join(root, </code><code class="string">'nrcs_front.yaml'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">try</code><code class="plain">:</code></div>
<div class="line"><code class="plain">                    os.rename(old_file_path, new_file_path)</code></div>
<div class="line"><code class="plain">                    files_rename.append(new_file_path)</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">print</code><code class="plain">(f</code><code class="string">'rename: {old_file_path} -> {new_file_path}'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">except</code><code class="plain"> Exception as e:</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">print</code><code class="plain">(f</code><code class="string">'[ERROR] rename {old_file_path} to {new_file_path}: {e}'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain"> files_rename</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">def</code><code class="plain"> generate_extrinsics_txt(yaml_path):</code></div>
<div class="line"><code class="plain">    first_flag </code><code class="keyword">=</code><code class="plain"> </code><code class="color1">True</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">for</code><code class="plain"> camera </code><code class="keyword">in</code><code class="plain"> [</code><code class="string">"front"</code><code class="plain">, </code><code class="string">"right"</code><code class="plain">, </code><code class="string">"rear"</code><code class="plain">, </code><code class="string">"left"</code><code class="plain">]:</code></div>
<div class="line"><code class="plain">        </code><code class="functions">file</code><code class="plain"> </code><code class="keyword">=</code><code class="plain"> os.path.join(yaml_path, f</code><code class="string">'nrcs_{camera}.yaml'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        fs </code><code class="keyword">=</code><code class="plain"> cv2.FileStorage(</code><code class="functions">file</code><code class="plain">, cv2.FILE_STORAGE_READ)</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> </code><code class="keyword">not</code><code class="plain"> fs.isOpened():</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">print</code><code class="plain">(f</code><code class="string">"can not open {file}"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            exit(</code><code class="value">0</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        initial_extrinsic </code><code class="keyword">=</code><code class="plain"> fs.getNode(</code><code class="string">"T_v_c"</code><code class="plain">).mat()</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> initial_extrinsic </code><code class="keyword">is</code><code class="plain"> </code><code class="color1">None</code><code class="plain">:</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">print</code><code class="plain">(</code><code class="string">"lack extrinsic"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            exit(</code><code class="value">0</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        T_v_c </code><code class="keyword">=</code><code class="plain"> np.array(initial_extrinsic, dtype</code><code class="keyword">=</code><code class="plain">np.float64)</code></div>
<div class="line"><code class="plain">        filename </code><code class="keyword">=</code><code class="plain"> os.path.join(yaml_path, </code><code class="string">'extrinsics.txt'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> first_flag:</code></div>
<div class="line"><code class="plain">            with </code><code class="functions">open</code><code class="plain">(filename, </code><code class="string">'w'</code><code class="plain">) as outfile:</code></div>
<div class="line"><code class="plain">                outfile.write(</code><code class="string">"CAM_NUM: 4\n"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">else</code><code class="plain">:</code></div>
<div class="line"><code class="plain">            with </code><code class="functions">open</code><code class="plain">(filename, </code><code class="string">'a'</code><code class="plain">) as outfile:</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">pass</code></div>
<div class="line"><code class="plain">        world1_T_world2 </code><code class="keyword">=</code><code class="plain"> np.array([[</code><code class="keyword">-</code><code class="value">1</code><code class="plain">, </code><code class="value">0</code><code class="plain">, </code><code class="value">0</code><code class="plain">, </code><code class="value">0</code><code class="plain">],</code></div>
<div class="line"><code class="plain">                                    [</code><code class="value">0</code><code class="plain">, </code><code class="keyword">-</code><code class="value">1</code><code class="plain">, </code><code class="value">0</code><code class="plain">, </code><code class="value">0</code><code class="plain">],</code></div>
<div class="line"><code class="plain">                                    [</code><code class="value">0</code><code class="plain">, </code><code class="value">0</code><code class="plain">, </code><code class="value">1</code><code class="plain">, </code><code class="value">0</code><code class="plain">],</code></div>
<div class="line"><code class="plain">                                    [</code><code class="value">0</code><code class="plain">, </code><code class="value">0</code><code class="plain">, </code><code class="value">0</code><code class="plain">, </code><code class="value">1</code><code class="plain">]], dtype</code><code class="keyword">=</code><code class="plain">np.float64)</code></div>
<div class="line"><code class="plain">        eigen_T_c_v </code><code class="keyword">=</code><code class="plain"> np.linalg.inv(T_v_c)</code></div>
<div class="line"><code class="plain">        cam_T_world1 </code><code class="keyword">=</code><code class="plain"> eigen_T_c_v</code></div>
<div class="line"><code class="plain">        cam_T_world2 </code><code class="keyword">=</code><code class="plain"> cam_T_world1 @ world1_T_world2</code></div>
<div class="line"><code class="plain">        cam_T_world2[</code><code class="value">0</code><code class="plain">, </code><code class="value">3</code><code class="plain">] </code><code class="keyword">*</code><code class="keyword">=</code><code class="plain"> </code><code class="value">1000.0</code></div>
<div class="line"><code class="plain">        cam_T_world2[</code><code class="value">1</code><code class="plain">, </code><code class="value">3</code><code class="plain">] </code><code class="keyword">*</code><code class="keyword">=</code><code class="plain"> </code><code class="value">1000.0</code></div>
<div class="line"><code class="plain">        cam_T_world2[</code><code class="value">2</code><code class="plain">, </code><code class="value">3</code><code class="plain">] </code><code class="keyword">*</code><code class="keyword">=</code><code class="plain"> </code><code class="value">1000.0</code></div>
<div class="line"><code class="plain">        world2_T_cam </code><code class="keyword">=</code><code class="plain"> np.linalg.inv(cam_T_world2)</code></div>
<div class="line"><code class="plain">        with </code><code class="functions">open</code><code class="plain">(filename, </code><code class="string">'a'</code><code class="plain">) as outfile:</code></div>
<div class="line"><code class="plain">            np.savetxt(outfile, cam_T_world2, fmt</code><code class="keyword">=</code><code class="string">'%.5f'</code><code class="plain">, delimiter</code><code class="keyword">=</code><code class="string">' '</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            np.savetxt(outfile, world2_T_cam, fmt</code><code class="keyword">=</code><code class="string">'%.5f'</code><code class="plain">, delimiter</code><code class="keyword">=</code><code class="string">' '</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            first_flag </code><code class="keyword">=</code><code class="plain"> </code><code class="color1">False</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">def</code><code class="plain"> generate_cam_txt(yaml_path):</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">for</code><code class="plain"> index, camera </code><code class="keyword">in</code><code class="plain"> </code><code class="functions">enumerate</code><code class="plain">([</code><code class="string">"front"</code><code class="plain">, </code><code class="string">"right"</code><code class="plain">, </code><code class="string">"rear"</code><code class="plain">, </code><code class="string">"left"</code><code class="plain">]):</code></div>
<div class="line"><code class="plain">        with </code><code class="functions">open</code><code class="plain">(os.path.join(yaml_path, f</code><code class="string">'nrcs_{camera}.yaml'</code><code class="plain">), </code><code class="string">'r'</code><code class="plain">) as </code><code class="functions">file</code><code class="plain">:</code></div>
<div class="line"><code class="plain">            lines </code><code class="keyword">=</code><code class="plain"> </code><code class="functions">file</code><code class="plain">.readlines()[</code><code class="value">2</code><code class="plain">:]</code></div>
<div class="line"><code class="plain">            split_index </code><code class="keyword">=</code><code class="plain"> </code><code class="functions">next</code><code class="plain">((i </code><code class="keyword">for</code><code class="plain"> i, line </code><code class="keyword">in</code><code class="plain"> </code><code class="functions">enumerate</code><code class="plain">(lines) </code><code class="keyword">if</code><code class="plain"> line.startswith(</code><code class="string">'T_v_c: !!opencv-matrix'</code><code class="plain">)), </code><code class="functions">len</code><code class="plain">(lines))</code></div>
<div class="line"><code class="plain">            data </code><code class="keyword">=</code><code class="plain"> yaml.safe_load(''.join(lines[:split_index]))</code></div>
<div class="line"><code class="plain">            </code></div>
<div class="line"><code class="plain">        image_width </code><code class="keyword">=</code><code class="plain"> data[</code><code class="string">'image_width'</code><code class="plain">]</code></div>
<div class="line"><code class="plain">        image_height </code><code class="keyword">=</code><code class="plain"> data[</code><code class="string">'image_height'</code><code class="plain">]</code></div>
<div class="line"><code class="plain">        poly_parameters </code><code class="keyword">=</code><code class="plain"> data[</code><code class="string">'poly_parameters'</code><code class="plain">]</code></div>
<div class="line"><code class="plain">        ss </code><code class="keyword">=</code><code class="plain"> f</code><code class="string">"{poly_parameters['p0']} {poly_parameters['p1']} {poly_parameters['p2']} {poly_parameters['p3']} {poly_parameters['p4']}"</code></div>
<div class="line"><code class="plain">        inv_poly_parameters </code><code class="keyword">=</code><code class="plain"> data[</code><code class="string">'inv_poly_parameters'</code><code class="plain">]</code></div>
<div class="line"><code class="plain">        ss_inv </code><code class="keyword">=</code><code class="plain"> </code><code class="string">" "</code><code class="plain">.join(</code><code class="functions">str</code><code class="plain">(inv_poly_parameters[f</code><code class="string">'p{i}'</code><code class="plain">]) </code><code class="keyword">for</code><code class="plain"> i </code><code class="keyword">in</code><code class="plain"> </code><code class="functions">range</code><code class="plain">(</code><code class="value">14</code><code class="plain">))</code></div>
<div class="line"><code class="plain">        affine_parameters </code><code class="keyword">=</code><code class="plain"> data[</code><code class="string">'affine_parameters'</code><code class="plain">]</code></div>
<div class="line"><code class="plain">        cx </code><code class="keyword">=</code><code class="plain"> affine_parameters[</code><code class="string">'cx'</code><code class="plain">]</code></div>
<div class="line"><code class="plain">        cy </code><code class="keyword">=</code><code class="plain"> affine_parameters[</code><code class="string">'cy'</code><code class="plain">]</code></div>
<div class="line"><code class="plain">        c </code><code class="keyword">=</code><code class="plain"> affine_parameters[</code><code class="string">'ac'</code><code class="plain">]</code></div>
<div class="line"><code class="plain">        d </code><code class="keyword">=</code><code class="plain"> affine_parameters[</code><code class="string">'ad'</code><code class="plain">]</code></div>
<div class="line"><code class="plain">        e </code><code class="keyword">=</code><code class="plain"> affine_parameters[</code><code class="string">'ae'</code><code class="plain">]</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">        with </code><code class="functions">open</code><code class="plain">(os.path.join(yaml_path, f</code><code class="string">'cam_{index}.txt'</code><code class="plain">), </code><code class="string">'w'</code><code class="plain">) as </code><code class="functions">file</code><code class="plain">:</code></div>
<div class="line"><code class="plain">            </code><code class="functions">file</code><code class="plain">.write(</code><code class="string">"Model: Ocam\n\n"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            </code><code class="functions">file</code><code class="plain">.write(f</code><code class="string">"width: {image_width}\n"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            </code><code class="functions">file</code><code class="plain">.write(f</code><code class="string">"height: {image_height}\n\n"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            </code><code class="functions">file</code><code class="plain">.write(f</code><code class="string">"ss: {ss}\n"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            </code><code class="functions">file</code><code class="plain">.write(f</code><code class="string">"ss_inv: {ss_inv}\n\n"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            </code><code class="functions">file</code><code class="plain">.write(f</code><code class="string">"cx: {cx}\n"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            </code><code class="functions">file</code><code class="plain">.write(f</code><code class="string">"cy: {cy}\n\n"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            </code><code class="functions">file</code><code class="plain">.write(f</code><code class="string">"c: {c}\n"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            </code><code class="functions">file</code><code class="plain">.write(f</code><code class="string">"d: {d}\n"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            </code><code class="functions">file</code><code class="plain">.write(f</code><code class="string">"e: {e}\n"</code><code class="plain">)</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">def</code><code class="plain"> main():</code></div>
<div class="line"><code class="plain">    parser </code><code class="keyword">=</code><code class="plain"> argparse.ArgumentParser(description</code><code class="keyword">=</code><code class="string">"generate bev by yaml"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    parser.add_argument(</code><code class="string">'-y'</code><code class="plain">, </code><code class="string">'--yaml_path'</code><code class="plain">, required</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">, </code><code class="functions">type</code><code class="keyword">=</code><code class="functions">str</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    args </code><code class="keyword">=</code><code class="plain"> parser.parse_args()</code></div>
<div class="line"><code class="plain">    yaml_path </code><code class="keyword">=</code><code class="plain"> args.yaml_path</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="keyword">if</code><code class="plain"> check_files_exist(yaml_path) </code><code class="keyword">is</code><code class="plain"> </code><code class="color1">False</code><code class="plain">:</code></div>
<div class="line"><code class="plain">        rename_files(yaml_path)</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">if</code><code class="plain"> check_files_exist(yaml_path) </code><code class="keyword">is</code><code class="plain"> </code><code class="color1">True</code><code class="plain">:</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">print</code><code class="plain">(</code><code class="string">'all nrcs_*.yaml is exist, generate bev ...'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        generate_extrinsics_txt(yaml_path)</code></div>
<div class="line"><code class="plain">        generate_cam_txt(yaml_path)</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">else</code><code class="plain">:</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">print</code><code class="plain">(</code><code class="string">'[ERROR] fail to generate bev without all nrcs_*.yaml'</code><code class="plain">)</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">if</code><code class="plain"> __name__ </code><code class="keyword">=</code><code class="keyword">=</code><code class="plain"> </code><code class="string">'__main__'</code><code class="plain">:</code></div>
<div class="line"><code class="plain">    main()</code></div>
</div>
    </div>
<p   
> Example of processing results </p>
<p   
><img  class="confluence-embedded-image confluence-thumbnail"  src="images/confluence/download/thumbnails/4416914771/image-2024-6-27_16-59-31-version-1-modificationdate-1719478771000-api-v2.png" alt="images/confluence/download/thumbnails/4416914771/image-2024-6-27_16-59-31-version-1-modificationdate-1719478771000-api-v2.png"  height="160" />
    </p>
    </div>
    <div class="section section-1" id="src-4416914771_safe-id-aWQt546v6KeG55u45py6QkVW5ou85o6l5pWw5o2u5YiG5p6Q5oyH5Y2X5YW85a65c2hhZG93X21vZGXjgIFwYXJraW5n44CB5Lqn57q_5qCH5a6a5ZKM5ZSu5ZCO5qCH5a6a5pWw5o2u5aSE55CGLeatpemqpOS6lO-8mui_m-ihjGJlduaLvOaOpQ">
        <h1 class="heading "><span> Step 5: BEV stitching </span></h1>
<p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;"> Single data: </span>
python3 stitch_bev.py -s image_path -p bev_path/ -m 0    </span>
</p>
<ul class=" "><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;">
-s / image_path：    <span style="color: #ff0000;">
    <span style="color: #000000;">
    <span style="color: #ff0000;">
    <span style="color: #000000;"> Evalent camera image </span>
    </span>
    </span>
    </span> Location (Step 2 Generates) </span>
    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;"> -P / bev_path: The path of yaml file and bev parameter <span style="color: #ff0000;">
    <span style="color: #000000;"> (Step 4 generation) </span>
    </span>
<br/>    </span>
    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;">
-m / stitch_mode：     <span style="color: #ff0000;">
    <span style="color: #000000;">
    <span style="color: #ff0000;">
    <span style="color: #000000;"> Specify </span>
    </span>
    </span>
    </span>
    </span>
    </span>
    <span style="color: #ff0000;">
    <span style="color: #000000;">
    <span style="color: #ff0000;">
    <span style="color: #000000;"> Splicing method (0 is 0 degrees stitching, 1 <span style="color: #ff0000;">
    <span style="color: #000000;">
    <span style="color: #ff0000;">
    <span style="color: #000000;"> It is 90 degrees stitching, 2 </span>
    </span>
    </span>
    </span>
    <span style="color: #ff0000;">
    <span style="color: #000000;">
    <span style="color: #ff0000;">
    <span style="color: #000000;"> It is 180 degrees stitching </span>
    </span>
    </span>
    </span>
）    </span>
    </span>
    </span>
    </span>
</p>
</li></ul><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;"> Batch processing: </span>
python3 batch_generate_bev.py -p data_path -t offline    <span style="color: #000000;"> or </span>
    </span>
    <span style="color: #ff0000;">
python3 data_path -t parking -n 3    </span>
</p>
<ul class=" "><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;"> -P / Data_Path: The path of yaml file and bev parameters <span style="color: #ff0000;">
    <span style="color: #000000;"> (Step 4 generation) </span>
    </span>
<br/>    </span>
    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;">
-t / type：offline/parking<br/>    </span>
    </span>
</p>
</li><li class=" "><p   
>    <span style="color: #ff0000;">
    <span style="color: #000000;"> -N / Parking_number: Frames ( <span style="color: #ff0000;">
    <span style="color: #000000;"> Optional parameter </span>
    </span>
），    </span>
    </span>
    <span style="color: #ff0000;">
    <span style="color: #000000;"> There is only one frame of data for production lines or after sale. No input is required (step -year generation) </span>
    </span>
</p>
</li></ul>    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">batch_generate_bev.py</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="batch_generate_bev.py" data-linenumbers="true" data-firstline="1">
<div class="line"><code class="keyword">import</code><code class="plain"> os</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> shutil</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> argparse</code></div>
<div class="line"><code class="keyword">import</code><code class="plain"> subprocess</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">def</code><code class="plain"> main():</code></div>
<div class="line"><code class="plain">    parser </code><code class="keyword">=</code><code class="plain"> argparse.ArgumentParser()</code></div>
<div class="line"><code class="plain">    parser.add_argument(</code><code class="string">'-p'</code><code class="plain">, </code><code class="string">'--data_path'</code><code class="plain">, required</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">, </code><code class="functions">type</code><code class="keyword">=</code><code class="functions">str</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    parser.add_argument(</code><code class="string">'-t'</code><code class="plain">, </code><code class="string">'--data_type'</code><code class="plain">, required</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">, default</code><code class="keyword">=</code><code class="string">'offline'</code><code class="plain">, </code><code class="functions">type</code><code class="keyword">=</code><code class="functions">str</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    parser.add_argument(</code><code class="string">'-n'</code><code class="plain">, </code><code class="string">'--parking_number'</code><code class="plain">, </code><code class="functions">type</code><code class="keyword">=</code><code class="functions">int</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    args </code><code class="keyword">=</code><code class="plain"> parser.parse_args()</code></div>
<div class="line"><code class="plain">    data_path </code><code class="keyword">=</code><code class="plain"> args.data_path</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    command_template </code><code class="keyword">=</code><code class="plain"> </code><code class="string">"python3 stitch_bev.py -s {image_path} -p {bev_path} -m {mode}"</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="keyword">for</code><code class="plain"> subdir </code><code class="keyword">in</code><code class="plain"> os.listdir(data_path):</code></div>
<div class="line"><code class="plain">        vin_path </code><code class="keyword">=</code><code class="plain"> os.path.join(data_path, subdir)</code></div>
<div class="line"><code class="plain">        bev_path </code><code class="keyword">=</code><code class="plain"> os.path.join(vin_path, </code><code class="string">'bev/'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        check_bev_path </code><code class="keyword">=</code><code class="plain"> os.path.join(bev_path, </code><code class="string">'check_bev'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> args.data_type </code><code class="keyword">=</code><code class="keyword">=</code><code class="plain"> </code><code class="string">'parking'</code><code class="plain">:</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">for</code><code class="plain"> p </code><code class="keyword">in</code><code class="plain"> </code><code class="functions">range</code><code class="plain">(args.parking_number):</code></div>
<div class="line"><code class="plain">                image_path </code><code class="keyword">=</code><code class="plain"> os.path.join(vin_path, f</code><code class="string">'parking/{p}/'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">for</code><code class="plain"> m </code><code class="keyword">in</code><code class="plain"> </code><code class="functions">range</code><code class="plain">(</code><code class="value">3</code><code class="plain">):</code></div>
<div class="line"><code class="plain">                    command </code><code class="keyword">=</code><code class="plain"> command_template.</code><code class="functions">format</code><code class="plain">(image_path</code><code class="keyword">=</code><code class="plain">image_path, bev_path</code><code class="keyword">=</code><code class="plain">bev_path, mode</code><code class="keyword">=</code><code class="plain">m)</code></div>
<div class="line"><code class="plain">                    subprocess.run(command, shell</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                    src_file </code><code class="keyword">=</code><code class="plain"> os.path.join(check_bev_path, f</code><code class="string">"origin_bev_{m}.png"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                    dst_file </code><code class="keyword">=</code><code class="plain"> os.path.join(vin_path, f</code><code class="string">"{subdir}_parking_{p}_{m}.png"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                    shutil.copy(src_file, dst_file)</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">elif</code><code class="plain"> args.data_type </code><code class="keyword">=</code><code class="keyword">=</code><code class="plain"> </code><code class="string">'offline'</code><code class="plain">:</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">for</code><code class="plain"> m </code><code class="keyword">in</code><code class="plain"> </code><code class="functions">range</code><code class="plain">(</code><code class="value">3</code><code class="plain">):</code></div>
<div class="line"><code class="plain">                command </code><code class="keyword">=</code><code class="plain"> command_template.</code><code class="functions">format</code><code class="plain">(image_path</code><code class="keyword">=</code><code class="plain">bev_path, bev_path</code><code class="keyword">=</code><code class="plain">bev_path, mode</code><code class="keyword">=</code><code class="plain">m)</code></div>
<div class="line"><code class="plain">                subprocess.run(command, shell</code><code class="keyword">=</code><code class="color1">True</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                src_file </code><code class="keyword">=</code><code class="plain"> os.path.join(check_bev_path, f</code><code class="string">"origin_bev_{m}.png"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                dst_file </code><code class="keyword">=</code><code class="plain"> os.path.join(vin_path, f</code><code class="string">"{subdir}_offline_{m}.png"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                shutil.copy(src_file, dst_file)</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">else</code><code class="plain">:</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">print</code><code class="plain">(</code><code class="string">'just support parking or offline data'</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">return</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="keyword">if</code><code class="plain"> __name__ </code><code class="keyword">=</code><code class="keyword">=</code><code class="plain"> </code><code class="string">"__main__"</code><code class="plain">:</code></div>
<div class="line"><code class="plain">    main()</code></div>
</div>
    </div>
<p   
> Example of Processing Results </p>
<p   
><img  class="confluence-embedded-image"  src="images/confluence/download/attachments/4416914771/image-2024-6-27_17-13-0-version-1-modificationdate-1719479581000-api-v2.png" alt="images/confluence/download/attachments/4416914771/image-2024-6-27_17-13-0-version-1-modificationdate-1719479581000-api-v2.png"  height="158" />
    </p>
    </div>
    <div class="section section-1" id="src-4416914771_safe-id-aWQt546v6KeG55u45py6QkVW5ou85o6l5pWw5o2u5YiG5p6Q5oyH5Y2X5YW85a65c2hhZG93X21vZGXjgIFwYXJraW5n44CB5Lqn57q_5qCH5a6a5ZKM5ZSu5ZCO5qCH5a6a5pWw5o2u5aSE55CGLeWFtuS7luWPguiAgw">
        <h1 class="heading "><span> Other reference </span></h1>
<p   
> 1. Use Wavizzzz STUDIO to play ROSBAG and subscribe to the following topic </p>
<ul class=" "><li class=" "><p   
> Select a frame of flat and rich texture in the/a/viper_parking/debug_stitched_img, right-click the download image, and it will be saved as a_viper_parking_debug_img-171877688887212505. PNG </p>
</li><li class=" "><p   
> Record/a/ARA_COM_GATAY_SLAVE/Sensor_CALIB_PARAMETERS_SENDERPORT </p>
<ul class=" "><li class=" "><p   
> Sensorxxtrinsic_calib_info's Calibinfo_calib_module </p>
</li><li class=" "><p   
> 12 (NRCS_FRONT) 13 (NRCS_REAR) 14 (NRCS_LEFT) 15 (NRCS_RIGHT) Cameraintrinsic_cx and Cameraintrinsic_Cy → Check whether the CX and CY of the surrounding camera are consistent to avoid inside and outside the camera. BEV stitching abnormal </p>
</li></ul></li></ul><p   
><img  class="confluence-embedded-image"  src="images/confluence/download/attachments/4416914771/image-2024-6-26_11-33-48-version-1-modificationdate-1719372830000-api-v2.png" alt="images/confluence/download/attachments/4416914771/image-2024-6-26_11-33-48-version-1-modificationdate-1719372830000-api-v2.png" width="1000"  />
    </p>
<p   
> 2. Use RALOCTL to parse ROSBAG data, generate a surrounding camera image, install and use reference <a   href="https://inside-docupedia.bosch.com/confluence/display/wave3/09+Raloctl+Release+Notes">09 Raloctl Release Notes</a></p>
<p   
><img  class="confluence-embedded-image"  src="images/confluence/download/attachments/4416914771/image-2024-6-26_11-56-9-version-1-modificationdate-1719374170000-api-v2.png" alt="images/confluence/download/attachments/4416914771/image-2024-6-26_11-56-9-version-1-modificationdate-1719374170000-api-v2.png"  height="150" />
    <img  class="confluence-embedded-image confluence-thumbnail"  src="images/confluence/download/thumbnails/4416914771/image-2024-6-26_11-54-54-version-1-modificationdate-1719374095000-api-v2.png" alt="images/confluence/download/thumbnails/4416914771/image-2024-6-26_11-54-54-version-1-modificationdate-1719374095000-api-v2.png"  height="150" />
    </p>
    </div>
        </div>

    </article>


            <nav id="ht-post-nav">
                <a href="4461810809_%E6%89%B0%E5%8A%A8%E7%8E%AF%E8%A7%86%E7%9B%B8%E6%9C%BA%E5%A4%96%E5%8F%82%E5%AF%B9_BEV_%E6%8B%BC%E6%8E%A5%E7%9A%84%E5%BD%B1%E5%93%8D.html" class="ht-post-nav-prev">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-prev" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-45.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span> The impact of disturbing surrounding camera on the stitching of BEV </span>
        </a>
                <a href="3274481029_%E9%87%8F%E4%BA%A7%E6%A0%87%E5%AE%9A%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83.html" class="ht-post-nav-next">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-next" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-225.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span> Mass production calibration code specification </span>
        </a>
    </nav>    
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>


    <script src="assets/js/expand-macro.js"></script>
</body>
</html>
